<div class="user-form-container">
  <mat-card class="form-card">
    <mat-card-header>
      <mat-card-title>{{ getTitle() }}</mat-card-title>
      <mat-card-subtitle *ngIf="!isSelfEdit">
        {{ isEditMode ? 'Modificar dados do usuário' : 'Criar novo usuário no sistema' }}
      </mat-card-subtitle>
      <mat-card-subtitle *ngIf="isSelfEdit">
        Edite suas informações pessoais
      </mat-card-subtitle>
    </mat-card-header>

    <!-- Loading indicator -->
    <div class="loading-container" *ngIf="loading">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Carregando dados do usuário...</p>
    </div>

    <mat-card-content *ngIf="!loading">
      <form [formGroup]="userForm" (ngSubmit)="onSubmit()" class="user-form">
        
        <div class="form-row">
          <!-- Nome de Família (Username) -->
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Nome de Família</mat-label>
            <input matInput 
                   formControlName="username" 
                   placeholder="Digite o nome de família"
                   [readonly]="!canEditUsername()">
            <mat-hint>Nome da família no jogo</mat-hint>
            <mat-error *ngIf="userForm.get('username')?.hasError('required')">
              Nome de família é obrigatório
            </mat-error>
            <mat-error *ngIf="userForm.get('username')?.hasError('minlength')">
              Nome deve ter pelo menos 3 caracteres
            </mat-error>
          </mat-form-field>



          <!-- Character Name -->
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Nome do Personagem</mat-label>
            <input matInput 
                   formControlName="characterName" 
                   placeholder="Digite o nome do personagem">
            <mat-hint>Nome do personagem principal</mat-hint>
            <mat-error *ngIf="userForm.get('characterName')?.hasError('required')">
              Nome do personagem é obrigatório
            </mat-error>
            <mat-error *ngIf="userForm.get('characterName')?.hasError('minlength')">
              Nome deve ter pelo menos 3 caracteres
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <!-- Profile (only for admin) -->
          <mat-form-field appearance="outline" class="form-field" *ngIf="canEditProfile()">
            <mat-label>Perfil</mat-label>
            <mat-select formControlName="profileId">
              <mat-option *ngFor="let profile of profiles" [value]="profile.id">
                {{ profile.name }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="userForm.get('profileId')?.hasError('required')">
              Perfil é obrigatório
            </mat-error>
          </mat-form-field>

          <!-- Active Status (only for admin editing others) -->
          <div class="checkbox-container" *ngIf="isAdminMode && !isSelfEdit">
            <mat-checkbox formControlName="active">
              Usuário ativo
            </mat-checkbox>
          </div>
        </div>

        <!-- Black Desert Online Section -->
        <mat-divider class="section-divider"></mat-divider>
        <h3 class="section-title">Informações do Black Desert Online</h3>

        <div class="form-row">
          <!-- Character Class -->
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Classe</mat-label>
            <mat-select formControlName="characterClass" (selectionChange)="onClassChange($event.value)">
              <mat-option *ngFor="let bdoClass of bdoClasses" [value]="bdoClass.name">
                {{ bdoClass.name }}
              </mat-option>
            </mat-select>
            <mat-hint>Classe do personagem principal</mat-hint>
          </mat-form-field>

          <!-- Class Type -->
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Tipo da Classe</mat-label>
            <mat-select formControlName="classType" [disabled]="!getAvailableClassTypes().length">
              <mat-option *ngFor="let type of getAvailableClassTypes()" [value]="type">
                {{ type }}
              </mat-option>
            </mat-select>
            <mat-hint>Awakening, Succession ou Ascension</mat-hint>
          </mat-form-field>
        </div>

        <div class="form-row">
          <!-- Attack Power (AP) -->
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Attack Power (AP)</mat-label>
            <input matInput 
                   type="number" 
                   formControlName="attackPower" 
                   placeholder="0"
                   min="0" 
                   max="500"
                   (input)="onPowerChange()">
            <mat-hint>Poder de ataque principal</mat-hint>
          </mat-form-field>

          <!-- Awakening Attack Power (APP) -->
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Awakening AP (APP)</mat-label>
            <input matInput 
                   type="number" 
                   formControlName="awakeningAttackPower" 
                   placeholder="0"
                   min="0" 
                   max="500"
                   (input)="onPowerChange()">
            <mat-hint>Poder de ataque do awakening/succession</mat-hint>
          </mat-form-field>
        </div>

        <div class="form-row">
          <!-- Defense Power (DP) -->
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Defense Power (DP)</mat-label>
            <input matInput 
                   type="number" 
                   formControlName="defensePower" 
                   placeholder="0"
                   min="0" 
                   max="500"
                   (input)="onPowerChange()">
            <mat-hint>Poder de defesa</mat-hint>
          </mat-form-field>

          <!-- Gear Score (GS) - Read Only -->
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Gear Score (GS)</mat-label>
            <input matInput 
                   type="number" 
                   [value]="calculatedGearScore"
                   readonly>
            <mat-hint>Calculado automaticamente: (AP + APP/2) + DP</mat-hint>
          </mat-form-field>
        </div>

        <!-- Password Section -->
        <div class="password-section" *ngIf="!isEditMode || shouldShowPassword()">
          <div class="password-header" *ngIf="isEditMode">
            <h4>Alterar Senha</h4>
            <button type="button" 
                    mat-button 
                    color="primary" 
                    (click)="togglePasswordChange()">
              {{ userForm.get('password')?.disabled ? 'Alterar senha' : 'Cancelar alteração' }}
            </button>
          </div>

          <div class="form-row" *ngIf="!userForm.get('password')?.disabled">
            <!-- Password -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>{{ isEditMode ? 'Nova senha' : 'Senha' }}</mat-label>
              <input matInput 
                     type="password" 
                     formControlName="password" 
                     placeholder="Digite a senha">
              <mat-error *ngIf="userForm.get('password')?.hasError('required')">
                Senha é obrigatória
              </mat-error>
              <mat-error *ngIf="userForm.get('password')?.hasError('minlength')">
                Senha deve ter pelo menos 6 caracteres
              </mat-error>
            </mat-form-field>

            <!-- Confirm Password -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Confirmar senha</mat-label>
              <input matInput 
                     type="password" 
                     formControlName="confirmPassword" 
                     placeholder="Confirme a senha">
              <mat-error *ngIf="userForm.get('confirmPassword')?.hasError('required')">
                Confirmação de senha é obrigatória
              </mat-error>
              <mat-error *ngIf="userForm.get('confirmPassword')?.hasError('passwordMismatch')">
                Senhas não conferem
              </mat-error>
            </mat-form-field>
          </div>
        </div>

        <!-- Actions -->
        <mat-card-actions class="form-actions">
          <button type="button" 
                  mat-button 
                  (click)="goBack()" 
                  [disabled]="saving">
            Cancelar
          </button>
          
          <button type="submit" 
                  mat-raised-button 
                  color="primary" 
                  [disabled]="userForm.invalid || saving">
            <mat-spinner diameter="20" *ngIf="saving" style="margin-right: 8px;"></mat-spinner>
            <span *ngIf="isSelfEdit">Salvar Alterações</span>
            <span *ngIf="!isSelfEdit">{{ isEditMode ? 'Atualizar' : 'Criar' }} Usuário</span>
          </button>
        </mat-card-actions>

      </form>
    </mat-card-content>
  </mat-card>
</div>
